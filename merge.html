<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChangePDF - 병합</title>
  <style>
    :root{
      --bg:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563eb; --primaryHover:#1d4ed8;
      --danger:#dc2626; --dangerHover:#b91c1c;
      --shadow:0 16px 32px rgba(15,23,42,.08);
      --card:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:26px 16px 80px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    h1{margin:0;font-size:20px}
    .sub{margin:6px 0 0;color:var(--muted);line-height:1.5}

    .card{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:none;cursor:pointer;border-radius:14px;padding:10px 12px;font-weight:900;transition:.15s}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primaryHover)}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--text)}
    .btn.ghost:hover{border-color:#cbd5e1}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.danger:hover{background:var(--dangerHover)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    input[type="file"]{display:none}
    .meta{color:var(--muted);font-size:13px;white-space:pre-wrap;margin-top:10px}

    /* Drop zone */
    .dz{
      margin-top:12px;
      border:2px dashed #cbd5e1;
      background:#f8fafc;
      border-radius:18px;
      padding:18px;
      transition:.15s ease;
    }
    .dz.dragover{background:#eef2ff;border-color:rgba(37,99,235,.45)}
    .dzTitle{margin:0;font-weight:950}
    .dzDesc{margin:6px 0 0;color:var(--muted);line-height:1.5;font-size:13px}

    /* File list */
    .fileGrid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .fileGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 720px){ .fileGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .fileCard{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      user-select:none;
      transition:.12s ease;
      position:relative;
    }
    .fileCard:hover{border-color:#cbd5e1; transform: translateY(-1px);}
    .fileCard[draggable="true"]{cursor:grab}
    .fileCard.dragging{
      opacity:.6;
      cursor:grabbing;
      outline:2px dashed rgba(37,99,235,.45);
      outline-offset:2px;
      transform:none;
    }
    .fileCard.dropTarget{
      outline:2px solid rgba(37,99,235,.35);
      outline-offset:2px;
    }
    .fileTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .fileName{
      font-weight:950;
      font-size:13px;
      line-height:1.25;
      word-break:break-word;
    }
    .fileSub{
      color:var(--muted);
      font-size:12px;
    }
    .xBtn{
      border:none;
      background:#f1f5f9;
      color:#0f172a;
      border-radius:12px;
      padding:6px 9px;
      cursor:pointer;
      font-weight:900;
    }
    .xBtn:hover{background:#e2e8f0}

    /* Add tile */
    .addTile{
      border:2px dashed #cbd5e1;
      background:#f8fafc;
      border-radius:16px;
      padding:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.12s ease;
      min-height: 104px;
    }
    .addTile:hover{background:#eef2ff; border-color:rgba(37,99,235,.45)}
    .addPlus{
      width:34px;height:34px;border-radius:12px;
      background:var(--primary); color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:950;
      font-size:18px;
    }
    .addText{font-weight:950; font-size:13px;}
    .addHint{color:var(--muted); font-size:12px; text-align:center; line-height:1.35;}

    .footerBar{
      margin-top:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      padding-top:14px;
      border-top:1px solid var(--line);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PDF 병합</h1>
        <p class="sub">
          파일을 추가하고(드래그&드롭 가능) 카드 순서를 드래그로 정렬한 후 “병합 다운로드”를 누르세요.
        </p>
      </div>
      <div class="row">
        <button class="btn ghost" id="backHome">처음으로</button>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <button class="btn primary" id="pickBtn">파일 추가</button>
        <button class="btn ghost" id="reloadBtn">목록 새로고침</button>
        <button class="btn danger" id="clearJobBtn">이 작업 비우기</button>
        <input id="fileInput" type="file" accept="application/pdf" multiple />
      </div>

      <div id="dropzone" class="dz" tabindex="0" role="button" aria-label="PDF 파일 추가 드롭존">
        <p class="dzTitle">여기에 PDF 파일을 끌어다 놓으면 추가됩니다</p>
        <p class="dzDesc">또는 “파일 추가” 버튼을 사용하세요. (여러 개 선택 가능)</p>
      </div>

      <div id="meta" class="meta"></div>
      <div id="status" class="meta"></div>

      <div id="fileGrid" class="fileGrid"></div>

      <div class="footerBar">
        <div class="meta" id="summary"></div>
        <div class="row">
          <button class="btn primary" id="mergeBtn">병합 다운로드</button>
        </div>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <script>
    // ===== IndexedDB helper (same contract as index.html) =====
    const DB_NAME = "changePDF";
    const DB_VERSION = 1;
    const STORE = "jobs";

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath: "jobId" });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function getJob(jobId){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).get(jobId);
        req.onsuccess = () => { db.close(); resolve(req.result || null); };
        req.onerror = () => { db.close(); reject(req.error); };
      });
    }
    async function putJob(job){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(job);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }
    async function addFilesToJob(jobId, fileList){
      const job = (await getJob(jobId)) || { jobId, createdAt: Date.now(), files: [] };
      const files = Array.from(fileList || []);
      for (const f of files){
        if ((f.type && f.type !== "application/pdf") && !f.name.toLowerCase().endsWith(".pdf")) continue;
        const bytes = await f.arrayBuffer();
        job.files.push({
          id: "f_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7),
          name: f.name,
          type: f.type || "application/pdf",
          bytes
        });
      }
      await putJob(job);
      return job;
    }
    async function clearJob(jobId){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).delete(jobId);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    // ===== Utils =====
    const $ = (s) => document.querySelector(s);
    const metaEl = $("#meta");
    const statusEl = $("#status");
    const summaryEl = $("#summary");
    const fileGrid = $("#fileGrid");
    const mergeBtn = $("#mergeBtn");

    function setMeta(msg){ metaEl.textContent = msg || ""; }
    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setSummary(msg){ summaryEl.textContent = msg || ""; }

    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    const jobId = qs("jobId");
    if (!jobId) location.href = "index.html";

    let job = null;

    function bytesToSize(bytes){
      const n = (bytes && bytes.byteLength) ? bytes.byteLength : 0;
      if (n < 1024) return `${n} B`;
      if (n < 1024*1024) return `${(n/1024).toFixed(1)} KB`;
      return `${(n/(1024*1024)).toFixed(1)} MB`;
    }

    // ===== File cards rendering =====
    function renderFiles(){
      fileGrid.innerHTML = "";

      const files = (job && job.files) ? job.files : [];
      if (files.length === 0){
        setSummary("파일이 없습니다. 위에서 파일을 추가하세요.");
        mergeBtn.disabled = true;
        return;
      }

      mergeBtn.disabled = files.length < 2; // 병합은 최소 2개 권장. 1개일 때도 허용하려면 이 줄 제거.
      setSummary(`현재 파일 ${files.length}개 · 드래그로 순서 변경 가능`);

      // Cards
      files.forEach((f, idx) => {
        const card = document.createElement("div");
        card.className = "fileCard";
        card.draggable = true;
        card.dataset.fileId = f.id;

        const top = document.createElement("div");
        top.className = "fileTop";

        const left = document.createElement("div");
        const name = document.createElement("div");
        name.className = "fileName";
        name.textContent = f.name;
        const sub = document.createElement("div");
        sub.className = "fileSub";
        sub.textContent = `${bytesToSize(f.bytes)} · #${idx+1}`;
        left.appendChild(name);
        left.appendChild(sub);

        const del = document.createElement("button");
        del.className = "xBtn";
        del.type = "button";
        del.textContent = "삭제";
        del.addEventListener("click", async (e) => {
          e.stopPropagation();
          job.files = job.files.filter(x => x.id !== f.id);
          await putJob(job);
          renderFiles();
          setStatus("파일을 삭제했습니다.");
        });

        top.appendChild(left);
        top.appendChild(del);
        card.appendChild(top);

        fileGrid.appendChild(card);
      });

      // Add tile (Smallpdf 느낌의 +)
      const add = document.createElement("div");
      add.className = "addTile";
      add.role = "button";
      add.tabIndex = 0;
      add.innerHTML = `
        <div class="addPlus">+</div>
        <div class="addText">파일 추가</div>
        <div class="addHint">클릭하거나 위 드롭존에 놓으세요</div>
      `;
      add.addEventListener("click", () => $("#fileInput").click());
      add.addEventListener("keydown", (e) => { if (e.key==="Enter" || e.key===" ") $("#fileInput").click(); });
      fileGrid.appendChild(add);

      enableFileDnD(fileGrid);
    }

    // ===== Drag reorder for file cards (updates job.files order) =====
    function enableFileDnD(container){
      let draggingEl = null;

      const getAfterElement = (y) => {
        const els = [...container.querySelectorAll(".fileCard:not(.dragging)")];
        let closest = { offset: Number.NEGATIVE_INFINITY, el: null };
        for (const child of els){
          const box = child.getBoundingClientRect();
          const offset = y - (box.top + box.height / 2);
          if (offset < 0 && offset > closest.offset) closest = { offset, el: child };
        }
        return closest.el;
      };

      container.addEventListener("dragstart", (e) => {
        const card = e.target.closest(".fileCard");
        if (!card) return;
        draggingEl = card;
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", card.dataset.fileId || "");
      }, { passive: true });

      container.addEventListener("dragend", async () => {
        if (draggingEl) draggingEl.classList.remove("dragging");
        draggingEl = null;
        container.querySelectorAll(".dropTarget").forEach(x => x.classList.remove("dropTarget"));

        // Persist new order to IndexedDB
        const orderedIds = Array.from(container.querySelectorAll(".fileCard"))
          .map(el => el.dataset.fileId)
          .filter(Boolean);

        // rebuild job.files in that order
        const map = new Map(job.files.map(f => [f.id, f]));
        job.files = orderedIds.map(id => map.get(id)).filter(Boolean);

        await putJob(job);
        renderFiles();
        setStatus("파일 순서를 저장했습니다.");
      });

      container.addEventListener("dragover", (e) => {
        e.preventDefault();
        const after = getAfterElement(e.clientY);
        const dragging = container.querySelector(".dragging");
        if (!dragging) return;

        container.querySelectorAll(".dropTarget").forEach(x => x.classList.remove("dropTarget"));
        if (after) after.classList.add("dropTarget");

        if (after == null) container.insertBefore(dragging, container.lastElementChild); // addTile 앞까지만
        else container.insertBefore(dragging, after);
      });

      container.addEventListener("drop", (e) => {
        e.preventDefault();
        container.querySelectorAll(".dropTarget").forEach(x => x.classList.remove("dropTarget"));
      });
    }

    // ===== Merge and download (file-level merge in current order) =====
    async function mergeAndDownload(){
      const files = job.files || [];
      if (files.length < 2){
        setStatus("병합은 최소 2개 파일이 필요합니다. 파일을 추가하세요.");
        return;
      }

      setStatus("병합 중...");
      const outPdf = await PDFLib.PDFDocument.create();

      for (let i=0; i<files.length; i++){
        const src = await PDFLib.PDFDocument.load(files[i].bytes);
        const pageIndices = src.getPageIndices();
        const copied = await outPdf.copyPages(src, pageIndices);
        copied.forEach(p => outPdf.addPage(p));
        if ((i+1) % 2 === 0) setStatus(`병합 중... (${i+1}/${files.length})`);
      }

      const outBytes = await outPdf.save();
      const blob = new Blob([outBytes], { type:"application/pdf" });
      const filename = `merged_${new Date().toISOString().slice(0,10)}.pdf`;

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setStatus(`완료: ${filename}`);
    }

    // ===== Load =====
    async function loadJob(){
      setStatus("작업 로딩 중...");
      job = await getJob(jobId);
      if (!job){
        setStatus("작업(jobId)을 찾을 수 없습니다. 처음으로 이동합니다.");
        location.href = "index.html";
        return;
      }
      setMeta(`jobId=${jobId}`);
      setStatus("");
      renderFiles();
    }

    // ===== Add files: button + dropzone =====
    $("#pickBtn").addEventListener("click", () => $("#fileInput").click());
    $("#fileInput").addEventListener("change", async () => {
      const files = $("#fileInput").files;
      if (!files || files.length === 0) return;
      setStatus("파일 추가 저장 중(IndexedDB)...");
      job = await addFilesToJob(jobId, files);
      $("#fileInput").value = "";
      renderFiles();
      setStatus("파일을 추가했습니다.");
    });

    const dz = $("#dropzone");
    dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.classList.add("dragover"); });
    dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
    dz.addEventListener("drop", async (e) => {
      e.preventDefault();
      dz.classList.remove("dragover");
      const files = e.dataTransfer.files;
      if (!files || files.length === 0) return;
      setStatus("파일 추가 저장 중(IndexedDB)...");
      job = await addFilesToJob(jobId, files);
      renderFiles();
      setStatus("파일을 추가했습니다.");
    });
    dz.addEventListener("click", () => $("#fileInput").click());
    dz.addEventListener("keydown", (e) => { if (e.key==="Enter" || e.key===" ") $("#fileInput").click(); });

    // ===== Controls =====
    $("#backHome").addEventListener("click", () => location.href = "index.html");
    $("#reloadBtn").addEventListener("click", loadJob);

    $("#clearJobBtn").addEventListener("click", async () => {
      await clearJob(jobId);
      job = { jobId, createdAt: Date.now(), files: [] };
      setStatus("이 작업(jobId)을 비웠습니다. 파일을 다시 추가하세요.");
      renderFiles();
    });

    $("#mergeBtn").addEventListener("click", async () => {
      $("#mergeBtn").disabled = true;
      try{
        await mergeAndDownload();
      } catch(e){
        console.error(e);
        setStatus("오류: " + (e.message || e));
      } finally {
        $("#mergeBtn").disabled = false;
      }
    });

    // init
    loadJob();
  </script>
</body>
</html>
