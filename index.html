<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChangePDF - 시작</title>
  <style>
    :root{
      --bg:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#2563eb; --primaryHover:#1d4ed8;
      --card:#fff; --shadow:0 16px 32px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 80px}
    header{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    h1{margin:0;font-size:22px;letter-spacing:-.2px}
    .sub{margin:6px 0 0;color:var(--muted);line-height:1.5}
    .card{margin-top:18px;background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    .dz{
      border:2px dashed #cbd5e1;border-radius:18px;background:#f8fafc;
      padding:26px; text-align:center; transition:.15s ease;
    }
    .dz.dragover{background:#eef2ff;border-color:rgba(37,99,235,.45)}
    .dzTitle{font-weight:900;font-size:18px;margin:0 0 6px}
    .dzDesc{margin:0;color:var(--muted);line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
    .btn{
      border:none;cursor:pointer;border-radius:14px;padding:12px 14px;font-weight:900;
      background:var(--primary);color:#fff;transition:.15s ease;
    }
    .btn:hover{background:var(--primaryHover)}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--text)}
    .btn.ghost:hover{border-color:#cbd5e1}
    input[type="file"]{display:none}
    .meta{margin-top:12px;color:var(--muted);font-size:13px;white-space:pre-wrap;text-align:center}
    .toolRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:18px}
    .toolCard{
      width:min(320px, 100%);
      border:1px solid var(--line);border-radius:16px;padding:14px;background:#fff;cursor:pointer;
      transition:.15s ease;
    }
    .toolCard:hover{transform:translateY(-1px);border-color:#cbd5e1}
    .toolTitle{margin:0;font-size:16px;font-weight:950}
    .toolDesc{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.45}
    .disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ChangePDF</h1>
        <p class="sub">파일을 끌어다 놓고, 다음 페이지에서 미리보기를 보면서 병합/분할하세요. (IndexedDB에 임시 저장)</p>
      </div>
    </header>

    <section class="card">
      <div id="dropzone" class="dz" role="button" tabindex="0">
        <p class="dzTitle">PDF 파일을 끌어와서 놓으세요</p>
        <p class="dzDesc">또는 버튼으로 파일을 선택하세요. 업로드 후 병합/분할 페이지로 이동합니다.</p>
        <div class="row">
          <button id="pickBtn" class="btn">파일 선택</button>
          <button id="clearBtn" class="btn ghost">초기화</button>
        </div>
        <input id="fileInput" type="file" accept="application/pdf" multiple />
        <div id="status" class="meta"></div>
      </div>

      <div class="toolRow" style="margin-top:18px;">
        <div id="goMerge" class="toolCard disabled" role="button" tabindex="0">
          <p class="toolTitle">PDF 병합</p>
          <p class="toolDesc">여러 파일을 합치고, 페이지 순서 변경/삭제 후 결과를 다운로드합니다.</p>
        </div>
        <div id="goSplit" class="toolCard disabled" role="button" tabindex="0">
          <p class="toolTitle">PDF 분할</p>
          <p class="toolDesc">한 파일을 페이지 단위로 추출하거나 개별 PDF/ZIP으로 분할합니다.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ========= IndexedDB helper (shared) =========
    const DB_NAME = "changePDF";
    const DB_VERSION = 1;
    const STORE = "jobs"; // key: jobId, value: { jobId, createdAt, files:[{id,name,type,bytes}] }

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) {
            db.createObjectStore(STORE, { keyPath: "jobId" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function putJob(job){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(job);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    async function getJob(jobId){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).get(jobId);
        req.onsuccess = () => { db.close(); resolve(req.result || null); };
        req.onerror = () => { db.close(); reject(req.error); };
      });
    }

    function newJobId(){
      return "job_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 9);
    }

    async function createOrLoadJob(jobId){
      let job = await getJob(jobId);
      if (!job){
        job = { jobId, createdAt: Date.now(), files: [] };
        await putJob(job);
      }
      return job;
    }

    async function addFilesToJob(jobId, fileList){
      const job = await createOrLoadJob(jobId);
      const files = Array.from(fileList || []);
      for (const f of files){
        const bytes = await f.arrayBuffer();
        job.files.push({
          id: "f_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7),
          name: f.name,
          type: f.type || "application/pdf",
          bytes
        });
      }
      await putJob(job);
      return job;
    }

    async function clearJob(jobId){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).delete(jobId);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { db.close(); reject(tx.error); };
      });
    }

    // ========= UI logic =========
    const dz = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const pickBtn = document.getElementById("pickBtn");
    const clearBtn = document.getElementById("clearBtn");
    const status = document.getElementById("status");
    const goMerge = document.getElementById("goMerge");
    const goSplit = document.getElementById("goSplit");

    let currentJobId = newJobId();
    let fileCount = 0;

    function setStatus(msg){ status.textContent = msg || ""; }
    function setEnabled(el, enabled){
      el.classList.toggle("disabled", !enabled);
    }
    function refresh(){
      const ok = fileCount > 0;
      setEnabled(goMerge, ok);
      setEnabled(goSplit, ok);
      setStatus(ok ? `준비됨: ${fileCount}개 파일 (jobId=${currentJobId})` : "파일을 추가하세요.");
    }

    async function handleFiles(files){
      if (!files || files.length === 0) return;
      setStatus("파일 저장 중(IndexedDB)...");
      const job = await addFilesToJob(currentJobId, files);
      fileCount = job.files.length;
      refresh();
    }

    dz.addEventListener("dragover", (e) => {
      e.preventDefault();
      dz.classList.add("dragover");
    });
    dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
    dz.addEventListener("drop", async (e) => {
      e.preventDefault();
      dz.classList.remove("dragover");
      await handleFiles(e.dataTransfer.files);
    });
    dz.addEventListener("click", () => fileInput.click());
    dz.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") fileInput.click(); });

    pickBtn.addEventListener("click", (e) => { e.stopPropagation(); fileInput.click(); });
    fileInput.addEventListener("change", async () => {
      await handleFiles(fileInput.files);
      fileInput.value = "";
    });

    clearBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      await clearJob(currentJobId);
      currentJobId = newJobId();
      fileCount = 0;
      refresh();
    });

    function go(page){
      // jobId 전달
      location.href = `${page}?jobId=${encodeURIComponent(currentJobId)}`;
    }
    goMerge.addEventListener("click", () => { if (fileCount>0) go("merge.html"); });
    goSplit.addEventListener("click", () => { if (fileCount>0) go("split.html"); });

    refresh();
  </script>
</body>
</html>
